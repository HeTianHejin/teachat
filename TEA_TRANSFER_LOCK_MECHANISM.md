# 茶叶转账锁定机制实现说明

## 问题背景

在茶叶转账流程中，存在一个关键的并发控制问题：

如果用户A账户余额为10克，发起转账给B用户10克，记录在A的"操作记录"中同时记录在B的待接收记录中。A需要在有效期内等待对方B"接受"转账，才能在"收支明细"中记入"转出"。

如果接收方B拒绝接受，则A和B没有实际茶叶流通，不应记入A"转出"。同样，收茶叶方B也是在确认后才能在"收支明细"中记录"转入"。

**核心问题**：需要锁定A"操作"（B待确认）中的10克茶叶，避免A在B没有操作（确认/取消）前又发起转账给C方10克茶叶。

## 解决方案

### 1. 数据库结构改进

添加锁定余额字段：

```sql
-- 用户茶叶账户表
ALTER TABLE tea_accounts ADD COLUMN locked_balance_grams FLOAT DEFAULT 0.0;

-- 团队茶叶账户表  
ALTER TABLE team_tea_accounts ADD COLUMN locked_balance_grams FLOAT DEFAULT 0.0;
```

### 2. 核心逻辑变更

#### 2.1 创建转账时（锁定资金）
- **之前**：直接扣除转出方余额，创建转出交易记录
- **现在**：
  1. 检查可用余额 = 总余额 - 锁定余额
  2. 创建待确认转账记录（status = 'pending'）
  3. **锁定转出方相应金额**（locked_balance_grams += amount）
  4. 不创建任何交易记录

#### 2.2 确认转账时（解锁并实际转账）
- **之前**：直接增加接收方余额
- **现在**：
  1. 验证转账状态和权限
  2. **实际扣除转出方余额**（balance_grams -= amount）
  3. **解锁锁定金额**（locked_balance_grams -= amount）
  4. 增加接收方余额（balance_grams += amount）
  5. 更新转账状态为已确认
  6. 创建双方交易记录

#### 2.3 拒绝转账时（仅解锁）
- **之前**：无处理（因为创建时已经扣款）
- **现在**：
  1. **解锁转出方锁定金额**（locked_balance_grams -= amount）
  2. 更新转账状态为已拒绝
  3. 不创建任何交易记录

#### 2.4 过期转账处理
- 添加定时任务每5分钟检查过期转账
- 自动解锁过期转账的锁定金额
- 更新转账状态为过期

### 3. 用户界面改进

在账户显示页面增加三种余额展示：
- **总余额**：账户茶叶资产总量
- **锁定余额**：待确认转账/操作中锁定的茶叶
- **可用余额**：可以立即使用的茶叶（总余额 - 锁定余额）

### 4. 并发安全保证

使用数据库事务和行级锁（`SELECT ... FOR UPDATE`）确保：
- 创建转账时原子性检查可用余额并锁定金额
- 确认/拒绝转账时原子性更新余额和锁定状态
- 防止重复转账和并发修改导致的数据不一致

## 技术实现细节

### 关键函数变更

1. **`CreateTeaTransfer` / `CreateTeaTransferToTeam`**
   - 余额检查改为检查可用余额
   - 扣款操作改为锁定操作

2. **`ConfirmTeaTransfer`**
   - 添加解锁锁定金额的逻辑
   - 确保原子性完成实际转账

3. **`RejectTeaTransfer`**
   - 添加解锁锁定金额的逻辑
   - 确保拒绝操作不影响实际余额

4. **新增 `ProcessExpiredTransfers`**
   - 批量处理过期转账
   - 自动解锁相关金额

### 定时任务

在 `main.go` 中添加定时任务：
```go
go func() {
    ticker := time.NewTicker(5 * time.Minute)
    defer ticker.Stop()
    
    for {
        select {
        case <-ticker.C:
            dao.ProcessExpiredTransfers()
        }
    }
}()
```

## 测试验证

创建测试脚本 `test_lock_mechanism.sql` 验证以下场景：

1. ✅ 正常转账锁定流程
2. ✅ 锁定后可用余额计算正确
3. ✅ 重复转账时余额不足检测
4. ✅ 确认转账后余额正确更新
5. ✅ 拒绝转账后锁定金额正确解锁
6. ✅ 过期转账自动处理

## 优势

1. **防止重复转账**：通过锁定机制确保发起方不会重复使用已锁定的资金
2. **原子性操作**：使用数据库事务确保资金操作的原子性
3. **用户体验优化**：清晰区分总余额、锁定余额和可用余额
4. **自动化处理**：定时任务自动处理过期转账，减少人工干预
5. **扩展性好**：可以轻松扩展到其他需要资金预占的业务场景

## 注意事项

1. 需要先运行数据库迁移脚本 `migration_add_locked_balance.sql`
2. 现有数据迁移时，locked_balance_grams 字段默认为0
3. 定时任务间隔可根据业务需求调整（当前5分钟）
4. 建议监控过期转账处理情况，及时发现异常