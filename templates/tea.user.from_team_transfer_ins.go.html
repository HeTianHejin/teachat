    {{ define "content" }}

<ol class="breadcrumb">
  <li><a href="/v1/">大堂</a></li>
  <li><a href="/v1/tea/user/account/page">{{ .SessUser.Name }} 的星茶罐</a></li>
  <li class="active">待确认团队转入</li>
</ol>

<div class="container">

    <div class="row">
        <!-- 个人星茶账户概览 -->
        <div class="col-md-12">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <span class="glyphicon glyphicon-leaf" aria-hidden="true"></span>
                        个人星茶账户
                        <span class="pull-right">
                            状态: <span class="label {{ if eq .TeaAccount.Status "frozen" }}label-danger{{ else }}label-success{{ end }}">{{ .StatusDisplay }}</span>
                        </span>
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h4>总余额: <strong>{{ .BalanceDisplay }}</strong></h4>
                            <p class="text-muted">您的星茶资产总量</p>
                        </div>
                        <div class="col-md-4">
                            <h4>锁定余额: <strong>{{ .LockedBalanceDisplay }}</strong></h4>
                            <p class="text-muted">待确认转账中锁定的星茶</p>
                        </div>
                        <div class="col-md-4">
                            <h4>可用余额: <strong>{{ .AvailableBalanceDisplay }}</strong></h4>
                            <p class="text-muted">可以立即使用的星茶</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 收入记录导航 -->
    <div class="row">
        <div class="col-md-12">
            <ul class="nav nav-tabs">
                <li>
                    <a href="/v1/tea/user/transfers/in/user_from_user/pending/page">
                        <span class="glyphicon glyphicon-user" aria-hidden="true"></span>
                        用户转入
                    </a>
                </li>
                <li class="active">
                    <a href="/v1/tea/user/transfers/in/user_from_team/pending/page">
                        <span class="glyphicon glyphicon-briefcase" aria-hidden="true"></span>
                        团队转入
                        <span class="badge">{{ len .Transfers }}</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- 待确认转账列表 -->
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-warning">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <span class="glyphicon glyphicon-time" aria-hidden="true"></span>
                        待确认团队转入
                        <small class="pull-right">请确认或拒绝来自团队的转账</small>
                    </h3>
                </div>
                <div class="panel-body">
                    {{ if .Transfers }}
                    <div class="alert alert-info">
                        <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
                        <strong>提示：</strong>您有 {{ len .Transfers }} 笔待确认的团队转账。请在过期前处理，过期后转账将自动退回给发送团队。
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>发送团队</th>
                                    <th>发起成员</th>
                                    <th>数量</th>
                                    <th>备注</th>
                                    <th>过期时间</th>
                                    <th>剩余时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{ range .Transfers }}
                                <tr class="{{ if .IsExpired }}danger{{ else }}warning{{ end }}">
                                    <td>{{ .CreatedAt.Format "2006-01-02 15:04" }}</td>
                                    <td>
                                        <span class="label label-primary">团队</span>
                                        {{ .FromTeamName }} (ID: {{ .FromTeamId }})
                                    </td>
                                    <td>
                                        <small class="text-muted">成员ID: {{ .InitiatorUserId }}</small>
                                    </td>
                                    <td>
                                        <span class="label label-success">{{ .AmountDisplay }}</span>
                                    </td>
                                    <td>
                                        {{ if .Notes }}
                                        <small class="text-muted">{{ .Notes }}</small>
                                        {{ else }}
                                        <small class="text-muted">-</small>
                                        {{ end }}
                                    </td>
                                    <td>
                                        {{ if .IsExpired }}
                                        <span class="text-danger">{{ .ExpiresAt.Format "2006-01-02 15:04" }}</span>
                                        {{ else }}
                                        <span class="text-success">{{ .ExpiresAt.Format "2006-01-02 15:04" }}</span>
                                        {{ end }}
                                    </td>
                                    <td>
                                        {{ if .IsExpired }}
                                        <span class="label label-danger">已过期</span>
                                        {{ else }}
                                        <span class="label label-info time-remaining" data-expires="{{ .ExpiresAt.Format "2006-01-02T15:04:05Z07:00" }}">计算中...</span>
                                        {{ end }}
                                    </td>
                                    <td>
                                        {{ if not .IsExpired }}
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-success" onclick="confirmTransfer('{{ .Uuid }}')">
                                                <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> 确认
                                            </button>
                                            <button type="button" class="btn btn-danger" onclick="rejectTransfer('{{ .Uuid }}')">
                                                <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> 拒绝
                                            </button>
                                        </div>
                                        {{ else }}
                                        <span class="text-muted">已过期</span>
                                        {{ end }}
                                    </td>
                                </tr>
                                {{ end }}
                            </tbody>
                        </table>
                    </div>

                    <!-- 分页导航 -->
                    <nav aria-label="Page navigation">
                        <ul class="pagination">
                            {{ if gt .CurrentPage 1 }}
                            <li>
                                <a href="?page={{ subtract .CurrentPage 1 }}&limit={{ .Limit }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo; 上一页</span>
                                </a>
                            </li>
                            {{ else }}
                            <li class="disabled">
                                <a href="#" aria-label="Previous">
                                    <span aria-hidden="true">&laquo; 上一页</span>
                                </a>
                            </li>
                            {{ end }}

                            {{ $currentPage := .CurrentPage }}
                            {{ $startPage := max 1 (subtract $currentPage 2) }}
                            {{ $endPage := add $startPage 4 }}
                            
                            {{ range $i := seq $startPage $endPage }}
                                {{ if eq $i $currentPage }}
                                <li class="active"><a href="?page={{ $i }}&limit={{ $.Limit }}">{{ $i }}</a></li>
                                {{ else }}
                                <li><a href="?page={{ $i }}&limit={{ $.Limit }}">{{ $i }}</a></li>
                                {{ end }}
                            {{ end }}

                            <li>
                                <a href="?page={{ add .CurrentPage 1 }}&limit={{ .Limit }}" aria-label="Next">
                                    <span aria-hidden="true">下一页 &raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                    {{ else }}
                    <div class="alert alert-success">
                        <h4><span class="glyphicon glyphicon-check" aria-hidden="true"></span> 暂无待确认团队转账</h4>
                        <p>您当前没有需要确认的团队转入。</p>
                        <p>当团队向您转账时，记录将显示在这里等待您的确认。</p>
                    </div>
                    {{ end }}
                </div>
            </div>
        </div>
    </div>

    <!-- 操作按钮 -->
    <div class="row">
        <div class="col-md-12">
            <div class="btn-group">
                <a href="/v1/tea/user/account/page" class="btn btn-default">
                    <span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span>
                    返回星茶罐
                </a>
                <a href="/v1/tea/user/transfers/history/user_to_user/page" class="btn btn-info">
                    <span class="glyphicon glyphicon-exchange" aria-hidden="true"></span>
                    转账历史
                </a>
                <a href="/v1/tea/user/transfers/in/user_from_team/completed/page" class="btn btn-success">
                    <span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span>
                    查看团队收入记录
                </a>
            </div>
        </div>
    </div>

</div>

{{ end }}

{{ define "scripts" }}
{{/* 
  ============================================
  用户待确认团队转入页面 - 自定义脚本
  功能：确认/拒绝团队转账 + 剩余时间计算
  注意：此脚本在 layout.go.html 的 {{ block "scripts" . }}{{ end }} 中加载
  ============================================
*/}}
<script>
// ============================================
// 1. 确认接收来自团队的转账
// ============================================
function confirmTransfer(transferUuid) {
    console.log('确认转账:', transferUuid);
    if (!confirm('确定要确认接收这笔团队转账吗？星茶将计入您的账户余额。')) {
        return;
    }
    
    fetch('/v1/tea/user/transfer/confirm/user_from_team', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            transfer_uuid: transferUuid
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('团队转账确认成功！星茶已计入您的账户。');
            location.reload();
        } else {
            alert('确认失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('确认请求失败，请重试');
    });
}

// ============================================
// 2. 拒绝来自团队的转账
// ============================================
function rejectTransfer(transferUuid) {
    console.log('拒绝转账:', transferUuid);
    var reason = prompt('请输入拒绝理由（可选）:', '');
    if (reason === null) {
        return;
    }
    
    fetch('/v1/tea/user/transfer/reject/user_from_team', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            transfer_uuid: transferUuid,
            reason: reason || ''
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('团队转账已拒绝，星茶将退回给发送团队。');
            location.reload();
        } else {
            alert('拒绝失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('拒绝请求失败，请重试');
    });
}

// ============================================
// 3. 页面加载完成后初始化
// ============================================
$(document).ready(function() {
    // 3.1 高亮当前选项卡
    $('.nav-tabs a[href="' + window.location.pathname + '"]').parent().addClass('active');
    
    // 3.2 页面加载时显示加载状态
    $('.pagination a').on('click', function(e) {
        $('.panel-body').addClass('loading');
    });

    // 3.3 计算并显示剩余时间（每分钟更新）
    function updateTimeRemaining() {
        $('.time-remaining').each(function() {
            var expiresStr = $(this).data('expires');
            console.log('Expires string:', expiresStr);
            
            if (!expiresStr) {
                $(this).text('未知');
                return;
            }
            
            var expiresAt = new Date(expiresStr);
            var now = new Date();
            var diff = expiresAt - now;
            
            console.log('Expires at:', expiresAt, 'Now:', now, 'Diff:', diff);
            
            if (isNaN(diff)) {
                $(this).text('格式错误');
                return;
            }
            
            if (diff <= 0) {
                $(this).removeClass('label-info').addClass('label-danger').text('已过期');
                return;
            }
            
            var hours = Math.floor(diff / (1000 * 60 * 60));
            var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 24) {
                var days = Math.floor(hours / 24);
                $(this).text(days + '天' + (hours % 24) + '小时');
            } else if (hours > 0) {
                $(this).text(hours + '小时' + minutes + '分钟');
            } else {
                $(this).removeClass('label-info').addClass('label-warning').text(minutes + '分钟');
            }
        });
    }
    
    updateTimeRemaining();
    setInterval(updateTimeRemaining, 60000);
});
</script>
<style>
.loading {
    opacity: 0.7;
    pointer-events: none;
}
.nav-tabs {
    margin-bottom: 20px;
}
.table-responsive {
    margin-bottom: 20px;
}
</style>
{{ end }}
