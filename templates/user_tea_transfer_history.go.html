{{ define "content" }}

<ol class="breadcrumb">
  <li><a href="/v1/">大堂</a></li>
  <li><a href="/v1/desk">{{ .SessUser.Name }} 的写字台</a></li>
  <li class="active">转账记录</li>
</ol>

<div class="container">

    <div class="row">
        <!-- 个人茶叶账户概览 -->
        <div class="col-md-12">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <span class="glyphicon glyphicon-leaf" aria-hidden="true"></span>
                        个人茶叶账户
                        <span class="pull-right">
                            状态: <span class="label {{ if eq .TeaAccount.Status "frozen" }}label-danger{{ else }}label-success{{ end }}">{{ .StatusDisplay }}</span>
                        </span>
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h4>当前余额: <strong>{{ .BalanceDisplay }}</strong></h4>
                            <p class="text-muted">您的茶叶资产总量</p>
                        </div>
                        <div class="col-md-6">
                            <div class="btn-group-vertical" role="group" style="width: 100%;">
                                <a href="/v1/desk" class="btn btn-default">
                                    <span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span>
                                    返回写字台
                                </a>
                                <a href="/v1/tea/transactions/page" class="btn btn-info">
                                    <span class="glyphicon glyphicon-list" aria-hidden="true"></span>
                                    收支明细
                                </a>
                                <a href="/v1/tea/transfers/pending/page" class="btn btn-warning">
                                    <span class="glyphicon glyphicon-time" aria-hidden="true"></span>
                                    待确认转账
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 转账记录列表 -->
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <span class="glyphicon glyphicon-exchange" aria-hidden="true"></span>
                        转账记录
                        <small class="pull-right">历史转账记录</small>
                    </h3>
                </div>
                <div class="panel-body">
                    {{ if .Transfers }}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>类型</th>
                                    <th>对方</th>
                                    <th>数量</th>
                                    <th>状态</th>
                                    <th>有效期</th>
                                    <th>备注</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{ range .Transfers }}
                                <tr class="{{ if .IsIncoming }}success{{ else }}warning{{ end }}">
                                    <td>{{ .CreatedAt.Format "01-02 15:04" }}</td>
                                    <td>
                                        {{ if .IsIncoming }}
                                        <span class="label label-success">转入</span>
                                        {{ else }}
                                        <span class="label label-warning">转出</span>
                                        {{ end }}
                                    </td>
                                    <td>
                                        {{ if .IsIncoming }}
                                        <div>
                                            <span class="label label-success">个人</span>
                                            <a href="/v1/user/biography?uuid={{ .FromUserId }}" class="text-success"> {{ .FromUserName }} (ID: {{ .FromUserId }})</a>
                                        </div>
                                        {{ else }}
                                        <div>
                                            <span class="label label-success">个人</span>
                                            <a href="/v1/user/biography?uuid={{ .ToUserId }}" class="text-success"> {{ .ToUserName }} (ID: {{ .ToUserId }})</a>
                                        </div>
                                        {{ end }}
                                    </td>
                                    <td>
                                        <strong>{{ .AmountDisplay }}</strong>
                                    </td>
                                    <td>
                                        <span class="label 
                                            {{ if eq .Status "已完成" }}label-success
                                            {{ else if eq .Status "待确认" }}label-info
                                            {{ else if eq .Status "已拒绝" }}label-danger
                                            {{ else if eq .Status "已过期" }}label-warning
                                            {{ else }}label-default{{ end }}">
                                            {{ .StatusDisplay }}
                                        </span>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ .ExpiresAt.Format "01-02 15:04" }}</small>
                                        {{ if and (eq .Status "待确认") .IsExpired }}
                                        <br><span class="text-danger">已过期</span>
                                        {{ end }}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ .Notes }}</small>
                                    </td>
                                </tr>
                                {{ end }}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 分页 -->
                    <nav aria-label="转账记录分页">
                        <ul class="pagination pagination-sm">
                            {{ if gt .CurrentPage 1 }}
                            <li>
                                <a href="/v1/tea/transfers/history/page?page={{ sub .CurrentPage 1 }}" aria-label="上一页">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {{ end }}
                            
                            <li class="active">
                                <span>第 {{ .CurrentPage }} 页</span>
                            </li>
                            
                            <li>
                                <a href="/v1/tea/transfers/history/page?page={{ add .CurrentPage 1 }}" aria-label="下一页">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                    
                    {{ else }}
                    <div class="alert alert-info">
                        <h4><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> 暂无转账记录</h4>
                        <p>您还没有任何转账记录。开始一些转账活动，这里就会显示您的转账历史了。</p>
                        <p>
                            <a href="/v1/desk" class="btn btn-primary">
                                <span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span>
                                返回写字台
                            </a>
                            <a href="#" onclick="showTransferModal()" class="btn btn-success">
                                <span class="glyphicon glyphicon-send" aria-hidden="true"></span>
                                发起转账
                            </a>
                        </p>
                    </div>
                    {{ end }}
                </div>
            </div>
        </div>
    </div>

</div>

<!-- 转账模态框 -->
<div class="modal fade" id="transferModal" tabindex="-1" role="dialog" aria-labelledby="transferModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="transferModalLabel">
                    <span class="glyphicon glyphicon-send" aria-hidden="true"></span>
                    发起茶叶转账
                </h4>
            </div>
            <div class="modal-body">
                <form id="transferForm">
                    <div class="form-group">
                        <label for="transferType">转账类型:</label>
                        <select class="form-control" id="transferType" onchange="toggleTransferTarget()">
                            <option value="user">转到个人</option>
                            <option value="team">转到团队</option>
                        </select>
                    </div>
                    <div class="form-group" id="toUserGroup">
                        <label for="toUserId">接收方用户ID:</label>
                        <input type="number" class="form-control" id="toUserId" name="to_user_id" required min="1">
                        <small class="help-block">请输入要转账的茶友用户ID</small>
                    </div>
                    <div class="form-group" id="toTeamGroup" style="display: none;">
                        <label for="toTeamId">接收方团队ID:</label>
                        <input type="number" class="form-control" id="toTeamId" name="to_team_id" required min="1">
                        <small class="help-block">请输入要转账的团队ID</small>
                    </div>
                    <div class="form-group">
                        <label for="amountGrams">转账数量(克):</label>
                        <input type="number" class="form-control" id="amountGrams" name="amount_grams" required min="0.001" step="0.001">
                        <small class="help-block">可输入小数，最小单位0.001克(1毫克)</small>
                    </div>
                    <div class="form-group">
                        <label for="notes">备注说明:</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="转账说明..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="expireHours">有效期(小时):</label>
                        <select class="form-control" id="expireHours" name="expire_hours">
                            <option value="6">6小时</option>
                            <option value="12">12小时</option>
                            <option value="24" selected>24小时</option>
                            <option value="48">48小时</option>
                            <option value="72">3天</option>
                            <option value="168">7天</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="submitTransfer()">确认转账</button>
            </div>
        </div>
    </div>
</div>

<script>
// 切换转账目标类型
function toggleTransferTarget() {
    const transferType = document.getElementById('transferType').value;
    const toUserGroup = document.getElementById('toUserGroup');
    const toTeamGroup = document.getElementById('toTeamGroup');
    const toUserId = document.getElementById('toUserId');
    const toTeamId = document.getElementById('toTeamId');
    
    if (transferType === 'user') {
        toUserGroup.style.display = 'block';
        toTeamGroup.style.display = 'none';
        toUserId.required = true;
        toTeamId.required = false;
        toUserId.value = '';
        toTeamId.value = '';
    } else {
        toUserGroup.style.display = 'none';
        toTeamGroup.style.display = 'block';
        toUserId.required = false;
        toTeamId.required = true;
        toUserId.value = '';
        toTeamId.value = '';
    }
}

// 显示转账模态框
function showTransferModal() {
    $('#transferModal').modal('show');
}

// 提交转账请求
function submitTransfer() {
    var form = document.getElementById('transferForm');
    var formData = new FormData(form);
    
    var transferType = document.getElementById('transferType').value;
    var transferData = {
        amount_grams: parseFloat(formData.get('amount_grams')),
        notes: formData.get('notes') || '',
        expire_hours: parseInt(formData.get('expire_hours'))
    };
    
    if (transferType === 'user') {
        transferData.to_user_id = parseInt(formData.get('to_user_id'));
        transferData.to_team_id = 0;
    } else {
        transferData.to_user_id = 0;
        transferData.to_team_id = parseInt(formData.get('to_team_id'));
    }
    
    // 验证数据
    if (transferType === 'user') {
        if (!transferData.to_user_id || transferData.to_user_id <= 0) {
            alert('请输入有效的接收方用户ID');
            return;
        }
    } else {
        if (!transferData.to_team_id || transferData.to_team_id <= 0) {
            alert('请输入有效的接收方团队ID');
            return;
        }
        // 检查是否向自由人团队转账（自由人团队ID为2）
        if (transferData.to_team_id === 2) {
            alert('不能向自由人团队转账，自由人团队不支持茶叶资产');
            return;
        }
    }
    
    if (!transferData.amount_grams || transferData.amount_grams <= 0) {
        alert('请输入有效的转账数量');
        return;
    }
    
    // 发送转账请求
    fetch('/v1/tea/transfer/new', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(transferData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (transferType === 'user') {
                alert('转账发起成功！接收方需要确认才能完成转账。');
            } else {
                alert('向团队转账成功！茶叶已直接转入团队账户。');
            }
            $('#transferModal').modal('hide');
            form.reset();
            toggleTransferTarget(); // 重置显示状态
            // 刷新页面显示新记录
            window.location.reload();
        } else {
            alert('转账失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('转账请求失败，请重试');
    });
}

// 页面加载完成后的初始化
$(document).ready(function() {
    // 可以在这里添加更多页面初始化逻辑
});
</script>

{{ end }}