{{ define "content" }}

{{/* 这是指定团队星茶账户  */}}

<ol class="breadcrumb">
  <li><a href="/v1/">大堂</a></li>
  <li><a href="/v1/teams/joined">团队事项</a></li>
  <li><a href="/v1/team/detail?uuid={{ .Team.Uuid }}">{{ .Team.Abbreviation }}</a></li>
  <li class="active">管理 #{{ .Team.Id }} 团队星茶账户</li>
</ol>

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div class="page-header">
                <h3>
                    {{ .Team.Name }}
                    <small>团队资产管理</small>
                </h3>
            </div>
        </div>
    </div>

    <!-- 待审批操作提示（仅核心成员可见） -->
    {{ if .UserIsCoreMember }}
    {{ if gt .PendingApprovalCount 0 }}
    <div class="row">
        <div class="col-md-12">
            <div class="alert alert-danger alert-dismissible" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4>
                    <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                    您有待审批的操作！
                </h4>
                <p>
                    您有 <strong>{{ .PendingApprovalCount }}</strong> 笔待审批的转账操作，
                    请及时审批以便锁定转账额度。
                    <a href="/v1/tea/team/operations/pending/page?team_id={{ .TeamAccount.TeamId }}" class="btn btn-danger btn-sm">立即审批</a>
                </p>
            </div>
        </div>
    </div>
    {{ end }}
    {{ end }}

    <!-- 待确认接收，来自其他团队转账提示 -->
    {{ if gt .PendingFromTeamCount 0 }}
    <div class="row">
        <div class="col-md-12">
            <div class="alert alert-warning alert-dismissible" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4>
                    <span class="glyphicon glyphicon-bell" aria-hidden="true"></span>
                    您有待确认的接收来自团队转账！
                </h4>
                <p>
                    您有 <strong>{{ .PendingFromTeamCount }}</strong> 笔待确认的接收记录，
                    请及时处理以免过期。
                    <a href="/v1/tea/team/transfers/pending/page?team_id={{ .TeamAccount.TeamId }}" class="btn btn-warning btn-sm">立即查看</a>
                </p>
            </div>
        </div>
    </div>
    {{ end }}
    <!-- 待确认接收，来自其他用户转账提示 -->
    {{ if gt .PendingFromUserCount 0 }}
    <div class="row">
        <div class="col-md-12">
            <div class="alert alert-warning alert-dismissible" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4>
                    <span class="glyphicon glyphicon-bell" aria-hidden="true"></span>
                    您有待确认的接收来自茶友转账！
                </h4>
                <p>
                    您有 <strong>{{ .PendingFromUserCount }}</strong> 笔待确认的接收记录，
                    请及时处理以免过期。
                    <a href="/v1/tea/team/transfers/pending/page?team_id={{ .TeamAccount.TeamId }}" class="btn btn-warning btn-sm">立即查看</a>
                </p>
            </div>
        </div>
    </div>
    {{ end }}

    <div class="row">
        <!-- 团队星茶账户概览 -->
        <div class="col-md-12">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <span class="glyphicon glyphicon-leaf" aria-hidden="true"></span>
                        星茶罐
                        <span class="pull-right">
                            状态: <span class="label {{ if eq .TeamAccount.Status "frozen" }}label-danger{{ else }}label-success{{ end }}">
                                {{ if eq .TeamAccount.Status "frozen" }}已冻结{{ else }}正常{{ end }}
                            </span>
                        </span>
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h4>总余额(毫克): <strong>{{ .TeamAccount.BalanceMilligrams }}</strong></h4>
                            <p class="text-muted">团队星茶资产总量</p>
                        </div>
                        <div class="col-md-4">
                            <h4>锁定余额(毫克): <strong>{{ .TeamAccount.LockedBalanceMilligrams }}</strong></h4>
                            <p class="text-muted">待确认操作中锁定的星茶</p>
                        </div>
                        <div class="col-md-4">
                            <h4>可用余额(毫克): <strong>{{ .TeamAccount.AvailableBalanceMilligrams }}</strong></h4>
                            <p class="text-muted"><strong>可以立即使用的星茶</strong></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>




    <div class="row">
        <!-- 功能快捷入口 -->
        <div class="col-md-6">
            <div class="panel panel-success">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                        收入管理
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="list-group">
                        <a href="/v1/tea/team/transfers/team_from_team/pending/page?team_id={{ .TeamAccount.TeamId }}" class="list-group-item {{ if gt .PendingFromTeamCount 0 }}list-group-item-warning{{ end }}">
                            <h4 class="list-group-item-heading">
                                <span class="glyphicon glyphicon-bell" aria-hidden="true"></span>
                                待确认接收来自团队转入的星茶
                                {{ if gt .PendingFromTeamCount 0 }}
                                <span class="badge">{{ .PendingFromTeamCount }}</span>
                                {{ end }}
                            </h4>
                            <p class="list-group-item-text">
                                {{ if gt .PendingFromTeamCount 0 }}
                                <strong>团队有 {{ .PendingFromTeamCount }} 笔待确认接收操作，请及时处理！</strong>
                                {{ else }}
                                待确认接收来自团队转入的星茶
                                {{ end }}
                            </p>
                        </a>
                        <a href="/v1/tea/team/transfers/team_from_user/pending/page?team_id={{ .TeamAccount.TeamId }}" class="list-group-item {{ if gt .PendingFromUserCount 0 }}list-group-item-warning{{ end }}">
                            <h4 class="list-group-item-heading">
                                <span class="glyphicon glyphicon-bell" aria-hidden="true"></span>
                                待确认接收来自个人转入的星茶
                                {{ if gt .PendingFromUserCount 0 }}
                                <span class="badge">{{ .PendingFromUserCount }}</span>
                                {{ end }}
                            </h4>
                            <p class="list-group-item-text">
                                {{ if gt .PendingFromUserCount 0 }}
                                <strong>团队有 {{ .PendingFromUserCount }} 笔待确认接收操作，请及时处理！</strong>
                                {{ else }}
                                待确认接收来自个人转入的星茶
                                {{ end }}
                            </p>
                        </a>
                        <a href="/v1/tea/team/transfers/team_from_team/completed/page?team_id={{ .TeamAccount.TeamId }}" class="list-group-item">
                            <h4 class="list-group-item-heading">
                                <span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span>
                                已成功来自团队记录
                            </h4>
                            <p class="list-group-item-text">查看所有已成功来自团队转入星茶的记录（已成功到账）</p>
                        </a>
                        <a href="/v1/tea/team/transfers/team_from_user/completed/page?team_id={{ .TeamAccount.TeamId }}" class="list-group-item">
                            <h4 class="list-group-item-heading">
                                <span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span>
                                已成功来自个人记录
                            </h4>
                            <p class="list-group-item-text">查看所有已成功来自个人转入星茶的记录（已成功到账）</p>
                        </a>
                        <a href="/v1/tea/team/transfers/team_from_team/Outstanding/page?team_id={{ .TeamAccount.TeamId }}" class="list-group-item">
                            <h4 class="list-group-item-heading">
                                <span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span>
                                未成功接收来自团队
                            </h4>
                            <p class="list-group-item-text">查看所有未成功接收来自团队星茶转入的记录（包括已拒绝、超时）</p>
                        </a>
                        <a href="/v1/tea/team/transfers/team_from_user/Outstanding/page?team_id={{ .TeamAccount.TeamId }}" class="list-group-item">
                            <h4 class="list-group-item-heading">
                                <span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span>
                                未成功接收来自个人
                            </h4>
                            <p class="list-group-item-text">查看所有未成功接收来自个人星茶转入的记录（包括已拒绝、超时）</p>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="panel panel-warning">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <span class="glyphicon glyphicon-minus" aria-hidden="true"></span>
                        支出管理
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="list-group">
                        <a href="#" onclick="showTransferModal()" class="list-group-item">
                            <h4 class="list-group-item-heading">
                                <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>
                                发起转账
                            </h4>
                            <p class="list-group-item-text">向其他团队或用户转账星茶</p>
                        </a>
                       
                        <a href="/v1/tea/team/transactions/page?team_id={{ .TeamAccount.TeamId }}&type=transfer_out" class="list-group-item">
                            <h4 class="list-group-item-heading">
                                <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>
                                已成功对团队转账记录
                            </h4>
                            <p class="list-group-item-text">查看所有对团队转出已完成的记录（已成功到账）</p>
                        </a>
                        <a href="/v1/tea/team/transactions/page?team_id={{ .TeamAccount.TeamId }}&type=transfer_out" class="list-group-item">
                            <h4 class="list-group-item-heading">
                                <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>
                                已成功对个人转账记录
                            </h4>
                            <p class="list-group-item-text">查看所有对个人转出已完成的记录（已成功到账）</p>
                        </a>
                        <a href="/v1/tea/team/transfers/out/page?team_id={{ .TeamAccount.TeamId }}" class="list-group-item">
                            <h4 class="list-group-item-heading">
                                <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>
                                对团队未完成记录
                            </h4>
                            <p class="list-group-item-text">查看所有对团队转出星茶未成功的记录（包含待接收、被拒绝、超时）</p>
                        </a>
                        <a href="/v1/tea/team/transfers/out/page?team_id={{ .TeamAccount.TeamId }}" class="list-group-item">
                            <h4 class="list-group-item-heading">
                                <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>
                                对个人未完成记录
                            </h4>
                            <p class="list-group-item-text">查看所有对个人转出星茶未成功的记录（包含待接收、被拒绝、超时）</p>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 管理操作 -->
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <span class="glyphicon glyphicon-cog" aria-hidden="true"></span>
                        管理转账操作
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="list-group">
                        <a href="/v1/tea/team/transfer/search?uuid={{ .Team.Uuid }}" class="list-group-item">
                            <h4 class="list-group-item-heading">
                                <span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span>
                                查找转账纪录
                            </h4>
                            <p class="list-group-item-text">查看对某个用户或者团队转账记录</p>
                        </a>
                        {{ if .UserIsCoreMember }}
                        <a href="/v1/tea/team/operations/pending/page?team_id={{ .TeamAccount.TeamId }}" class="list-group-item {{ if gt .PendingApprovalCount 0 }}list-group-item-danger{{ end }}">
                            <h4 class="list-group-item-heading">
                                <span class="glyphicon glyphicon-time" aria-hidden="true"></span>
                                待审批操作
                                {{ if gt .PendingApprovalCount 0 }}
                                <span class="badge">{{ .PendingApprovalCount }}</span>
                                {{ end }}
                            </h4>
                            <p class="list-group-item-text">
                                {{ if gt .PendingApprovalCount 0 }}
                                <strong>您有 {{ .PendingApprovalCount }} 笔待审批操作，请及时处理！</strong>
                                {{ else }}
                                审批团队星茶账户的待处理操作
                                {{ end }}
                            </p>
                        </a>
                        {{ end }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 转账模态框 -->
<div class="modal fade" id="transferModal" tabindex="-1" role="dialog" aria-labelledby="transferModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="transferModalLabel">
                    <span class="glyphicon glyphicon-send" aria-hidden="true"></span>
                    发起团队星茶转账
                </h4>
            </div>
            <div class="modal-body">
                <form id="transferForm">
                    <div class="form-group">
                        <label for="transferType">转账类型:</label>
                        <select class="form-control" id="transferType" onchange="toggleTransferTarget()">
                            <option value="team">转到团队</option>
                            <option value="user">转到个人</option>
                        </select>
                    </div>
                    <div class="form-group" id="toTeamGroup">
                        <label for="toTeamId">接收方团队ID:</label>
                        <input type="number" class="form-control" id="toTeamId" name="to_team_id" required min="1">
                        <small class="help-block">请输入要转账的团队ID</small>
                    </div>
                    <div class="form-group" id="toUserGroup" style="display: none;">
                        <label for="toUserId">接收方用户ID:</label>
                        <input type="number" class="form-control" id="toUserId" name="to_user_id" required min="1">
                        <small class="help-block">请输入要转账的用户ID</small>
                    </div>
                    <div class="form-group">
                        <label for="amountMilligrams">转账数量(毫克):</label>
                        <input type="number" class="form-control" id="amountMilligrams" name="amount_milligrams" required min="0.001" step="0.001">
                        <small class="help-block">当前余额(毫克): {{ printf "%.3f" .TeamAccount.BalanceMilligrams }} 克，可输入小数，最小单位0.001克(1毫克)</small>
                    </div>
                    <div class="form-group">
                        <label for="notes">备注说明:</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="转账说明..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="expireHours">有效期(小时):</label>
                        <select class="form-control" id="expireHours" name="expire_hours">
                            <option value="6">6小时</option>
                            <option value="12">12小时</option>
                            <option value="24" selected>24小时</option>
                            <option value="48">48小时</option>
                            <option value="72">3天</option>
                            <option value="168">7天</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="submitTransfer()">确认转账</button>
            </div>
        </div>
    </div>
</div>

<script>
const teamId = "{{ .TeamAccount.TeamId }}";

// 切换转账目标类型
function toggleTransferTarget() {
    const transferType = document.getElementById('transferType').value;
    const toTeamGroup = document.getElementById('toTeamGroup');
    const toUserGroup = document.getElementById('toUserGroup');
    const toTeamId = document.getElementById('toTeamId');
    const toUserId = document.getElementById('toUserId');
    
    if (transferType === 'team') {
        toTeamGroup.style.display = 'block';
        toUserGroup.style.display = 'none';
        toTeamId.required = true;
        toUserId.required = false;
        toTeamId.value = '';
        toUserId.value = '';
    } else {
        toTeamGroup.style.display = 'none';
        toUserGroup.style.display = 'block';
        toTeamId.required = false;
        toUserId.required = true;
        toTeamId.value = '';
        toUserId.value = '';
    }
}

// 显示转账模态框
function showTransferModal() {
    $('#transferModal').modal('show');
}

// 提交转账请求
function submitTransfer() {
    var form = document.getElementById('transferForm');
    var formData = new FormData(form);
    
    var transferType = document.getElementById('transferType').value;
    var transferData = {
        operation_type: 'transfer_out',
        amount_milligrams: parseFloat(formData.get('amount_milligrams')),
        notes: formData.get('notes') || '',
        expire_hours: parseInt(formData.get('expire_hours'))
    };
    
    if (transferType === 'team') {
        transferData.target_team_id = parseInt(formData.get('to_team_id'));
        transferData.target_user_id = null;
    } else {
        transferData.target_team_id = null;
        transferData.target_user_id = parseInt(formData.get('to_user_id'));
    }
    
    // 验证数据
    if (transferType === 'team') {
        if (!transferData.target_team_id || transferData.target_team_id <= 0) {
            alert('请输入有效的接收方团队ID');
            return;
        }
        // 检查是否向自由人团队转账（自由人团队ID为2）
        if (transferData.target_team_id === 2) {
            alert('不能向自由人团队转账，自由人团队不支持星茶资产');
            return;
        }
    } else {
        if (!transferData.target_user_id || transferData.target_user_id <= 0) {
            alert('请输入有效的接收方用户ID');
            return;
        }
    }
    
    if (!transferData.amount_milligrams || transferData.amount_milligrams <= 0) {
        alert('请输入有效的转账数量');
        return;
    }
    
    // 发送操作请求
    fetch('/v1/tea/team/operation/new?team_id=' + teamId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify(transferData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.data && data.data.status === 'approved') {
                alert('转账已成功执行！');
            } else {
                alert('转账发起成功！等待其他核心成员审批。');
            }
            $('#transferModal').modal('hide');
            form.reset();
            toggleTransferTarget(); // 重置显示状态
            // 刷新页面显示新记录
            window.location.reload();
        } else {
            alert('转账失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('转账请求失败，请重试');
    });
}

// 页面加载完成后的初始化
$(document).ready(function() {
    // 初始化转账目标显示
    toggleTransferTarget();
});
</script>
{{ end }}