# å®¶åº­è§†è§’ä¸æ¶ˆæ¯é€šçŸ¥æœºåˆ¶

## æ ¸å¿ƒæ¦‚å¿µ

### è§†è§’å­—æ®µ (PerspectiveUserId)
æ¯ä¸ªFamilyè®°å½•éƒ½æœ‰ä¸€ä¸ª`perspective_user_id`å­—æ®µï¼Œè¡¨ç¤º"è¿™æ˜¯è°çœ¼ä¸­çš„å®¶åº­"ã€‚

**ç¤ºä¾‹**ï¼š
- å¼ ä¸‰ç™»è®°çš„å®¶åº­ï¼š`perspective_user_id = å¼ ä¸‰ID`
- æå››ç™»è®°çš„åŒä¸€ä¸ªå®¶åº­ï¼š`perspective_user_id = æå››ID`

## åº”ç”¨åœºæ™¯

### 1. æµè§ˆå®¶æ—æ ‘æ—¶é€‰æ‹©è§†è§’

```go
// è·å–ç”¨æˆ·è§†è§’çš„å®¶æ—æ ‘
tree, err := GetUserPerspectiveFamilyTree(userId)

// æ ‘ç»“æ„ï¼š
// ç¥–çˆ¶æ¯å®¶åº­ (-2ä»£)
//     â†“
// çˆ¶æ¯å®¶åº­ (-1ä»£)
//     â†“
// æœ¬äººå®¶åº­ (0ä»£) â† ç”¨æˆ·è§†è§’
//     â†“
// å­å¥³å®¶åº­ (+1ä»£)
```

### 2. æ¶ˆæ¯é€šçŸ¥åå¥½è®¾ç½®

ç”¨æˆ·å¯ä»¥ä¸ºæ¯ä¸ªå®¶åº­è®¾ç½®æ¶ˆæ¯æ¥æ”¶åå¥½ï¼š

```go
// åˆ›å»ºæ¶ˆæ¯åå¥½
pref := FamilyMessagePreference{
    UserId:           userId,
    FamilyId:         familyId,
    ReceiveMessages:  true,           // æ¥æ”¶æ¶ˆæ¯
    NotificationType: NotificationTypeImportant, // ä»…é‡è¦æ¶ˆæ¯
}
pref.Create()
```

### 3. é™éŸ³æŸä¸ªå®¶åº­

```go
// é™éŸ³7å¤©
mutedUntil := time.Now().Add(7 * 24 * time.Hour)
pref := FamilyMessagePreference{
    UserId:           userId,
    FamilyId:         familyId,
    ReceiveMessages:  false,
    MutedUntil:       &mutedUntil,
}
pref.Create()
```

## å®é™…ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1ï¼šä¹”å¸ƒæ–¯çš„å®¶æ—æ ‘è§†è§’

```go
// ä¹”å¸ƒæ–¯åªç™»è®°äº†å…»çˆ¶æ¯å®¶åº­
jobs := User{Id: 1, Name: "Steve Jobs"}
tree, _ := GetUserPerspectiveFamilyTree(jobs.Id)

// ä»–çš„å®¶æ—æ ‘ï¼š
// å…»çˆ¶æ¯å®¶åº­ (Paul & Clara Jobs)
//     â†“
// ä¹”å¸ƒæ–¯å®¶åº­ (Steve & Laurene)
//     â†“
// å­å¥³å®¶åº­

// æ³¨æ„ï¼šç”Ÿçˆ¶æ¯å®¶åº­ä¸åœ¨ä»–çš„è§†è§’ä¸­
```

### åœºæ™¯2ï¼šMonaçš„å®¶æ—æ ‘è§†è§’

```go
// Monaç™»è®°äº†ç”Ÿçˆ¶æ¯å®¶åº­
mona := User{Id: 2, Name: "Mona Simpson"}
tree, _ := GetUserPerspectiveFamilyTree(mona.Id)

// å¥¹çš„å®¶æ—æ ‘ï¼š
// ç”Ÿçˆ¶æ¯å®¶åº­ (Jandali & Schieble)
//     â†“
// Monaå®¶åº­
//     â†“
// å­å¥³å®¶åº­

// å¥¹çš„æ ‘ä¸­åŒ…å«ä¹”å¸ƒæ–¯ä½œä¸ºå…„å¼Ÿ
```

### åœºæ™¯3ï¼šæ¶ˆæ¯é€šçŸ¥ç®¡ç†

```go
// ç”¨æˆ·ç•Œé¢ï¼šç®¡ç†å®¶åº­æ¶ˆæ¯é€šçŸ¥
func ManageFamilyNotifications(userId int) {
    // 1. è·å–ç”¨æˆ·çš„å®¶æ—æ ‘
    tree, _ := GetUserPerspectiveFamilyTree(userId)
    
    // 2. æ˜¾ç¤ºæ‰€æœ‰å®¶åº­ï¼Œè®©ç”¨æˆ·é€‰æ‹©
    // - çˆ¶æ¯å®¶åº­ï¼šæ¥æ”¶å…¨éƒ¨æ¶ˆæ¯ âœ…
    // - é…å¶å®¶åº­ï¼šæ¥æ”¶å…¨éƒ¨æ¶ˆæ¯ âœ…
    // - å‰é…å¶å®¶åº­ï¼šé™éŸ³ ğŸ”‡
    // - å­å¥³å®¶åº­ï¼šä»…é‡è¦æ¶ˆæ¯ âš ï¸
    
    // 3. ä¿å­˜ç”¨æˆ·çš„é€‰æ‹©
    for _, family := range families {
        pref := FamilyMessagePreference{
            UserId:           userId,
            FamilyId:         family.Id,
            ReceiveMessages:  userChoice.Receive,
            NotificationType: userChoice.Type,
        }
        pref.Create()
    }
}
```

### åœºæ™¯4ï¼šå‘é€æ¶ˆæ¯å‰æ£€æŸ¥

```go
// å‘é€å®¶åº­æ¶ˆæ¯å‰ï¼Œæ£€æŸ¥æ¥æ”¶è€…çš„åå¥½
func SendFamilyMessage(senderId int, receiverId int, message string) error {
    // æ£€æŸ¥æ¥æ”¶è€…æ˜¯å¦æ„¿æ„æ¥æ”¶æ¥è‡ªå‘é€è€…å®¶åº­çš„æ¶ˆæ¯
    shouldReceive, err := ShouldReceiveMessageFrom(receiverId, senderId)
    if err != nil {
        return err
    }
    
    if !shouldReceive {
        return errors.New("æ¥æ”¶è€…å·²å…³é—­æ¥è‡ªè¯¥å®¶åº­çš„æ¶ˆæ¯é€šçŸ¥")
    }
    
    // å‘é€æ¶ˆæ¯
    return sendMessage(receiverId, message)
}
```

## å®¶æ—æ ‘ç»“æ„

### FamilyTreeNode ç»“æ„

```go
type FamilyTreeNode struct {
    Family       Family           // å®¶åº­ä¿¡æ¯
    Generation   int              // ä»£æ•°ï¼š-2,-1,0,1,2
    Relationship string           // å…³ç³»æè¿°
    Children     []FamilyTreeNode // å­èŠ‚ç‚¹
}
```

### ä»£æ•°è¯´æ˜

| Generation | è¯´æ˜ | ç¤ºä¾‹ |
|------------|------|------|
| -2 | ç¥–çˆ¶æ¯è¾ˆ | çˆ·çˆ·å¥¶å¥¶ã€å¤–å…¬å¤–å©† |
| -1 | çˆ¶æ¯è¾ˆ | çˆ¶æ¯ã€å²³çˆ¶æ¯ |
| 0 | æœ¬äººè¾ˆ | è‡ªå·±çš„å®¶åº­ |
| 1 | å­å¥³è¾ˆ | å„¿å­å¥³å„¿çš„å®¶åº­ |
| 2 | å­™å­å¥³è¾ˆ | å­™å­å­™å¥³çš„å®¶åº­ |

## æ¶ˆæ¯é€šçŸ¥ç±»å‹

| ç±»å‹ | å€¼ | è¯´æ˜ |
|------|---|------|
| å…³é—­ | 0 | ä¸æ¥æ”¶ä»»ä½•æ¶ˆæ¯ |
| ä»…é‡è¦ | 1 | åªæ¥æ”¶é‡è¦æ¶ˆæ¯ï¼ˆç”Ÿæ—¥ã€å©šç¤¼ç­‰ï¼‰ |
| å…¨éƒ¨ | 2 | æ¥æ”¶æ‰€æœ‰æ¶ˆæ¯ |

## UIè®¾è®¡å»ºè®®

### å®¶æ—æ ‘é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æˆ‘çš„å®¶æ—æ ‘ (å¼ ä¸‰çš„è§†è§’)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  ç¥–çˆ¶æ¯å®¶åº­ ğŸ‘´ğŸ‘µ                     â”‚
â”‚       â†“                             â”‚
â”‚  çˆ¶æ¯å®¶åº­ ğŸ‘¨ğŸ‘©                       â”‚
â”‚       â†“                             â”‚
â”‚  æˆ‘çš„å®¶åº­ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ â† å½“å‰è§†è§’          â”‚
â”‚       â†“                             â”‚
â”‚  å­å¥³å®¶åº­ ğŸ‘¶                         â”‚
â”‚                                     â”‚
â”‚  [åˆ‡æ¢è§†è§’] [æ¶ˆæ¯è®¾ç½®]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶ˆæ¯åå¥½è®¾ç½®é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¶åº­æ¶ˆæ¯é€šçŸ¥è®¾ç½®                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  çˆ¶æ¯å®¶åº­                            â”‚
â”‚  â—‹ å…³é—­  â—‹ ä»…é‡è¦  â— å…¨éƒ¨           â”‚
â”‚  [é™éŸ³7å¤©]                          â”‚
â”‚                                     â”‚
â”‚  é…å¶å®¶åº­                            â”‚
â”‚  â—‹ å…³é—­  â—‹ ä»…é‡è¦  â— å…¨éƒ¨           â”‚
â”‚                                     â”‚
â”‚  å‰é…å¶å®¶åº­                          â”‚
â”‚  â— å…³é—­  â—‹ ä»…é‡è¦  â—‹ å…¨éƒ¨           â”‚
â”‚  ğŸ”‡ å·²é™éŸ³è‡³ 2024-12-31             â”‚
â”‚                                     â”‚
â”‚  å­å¥³å®¶åº­                            â”‚
â”‚  â—‹ å…³é—­  â— ä»…é‡è¦  â—‹ å…¨éƒ¨           â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## APIæ¥å£

### è·å–å®¶æ—æ ‘
```go
GET /api/family/tree/:userId
Response: FamilyTreeNode
```

### è·å–æ¶ˆæ¯åå¥½
```go
GET /api/family/message-preferences
Response: []FamilyMessagePreference
```

### æ›´æ–°æ¶ˆæ¯åå¥½
```go
POST /api/family/message-preferences
Body: {
    family_id: 123,
    receive_messages: true,
    notification_type: 2
}
```

### é™éŸ³å®¶åº­
```go
POST /api/family/mute/:familyId
Body: {
    duration_days: 7
}
```

## æ•°æ®åº“è¿ç§»

```bash
# æ‰§è¡Œè¿ç§»
psql -d teachat -f sql/add_perspective_and_message_prefs.sql
```

## å…³é”®ä¼˜åŠ¿

âœ… **ä¸ªæ€§åŒ–è§†è§’** - æ¯ä¸ªäººçœ‹åˆ°è‡ªå·±è®¤å¯çš„å®¶æ—æ ‘  
âœ… **çµæ´»é€šçŸ¥** - ç²¾ç»†æ§åˆ¶æ¯ä¸ªå®¶åº­çš„æ¶ˆæ¯  
âœ… **éšç§ä¿æŠ¤** - å¯ä»¥é™éŸ³æˆ–å…³é—­ä¸æƒ³è”ç³»çš„å®¶åº­  
âœ… **æ˜“äºç®¡ç†** - ç›´è§‚çš„æ ‘å½¢ç»“æ„å±•ç¤º  
âœ… **æ”¯æŒå¤æ‚å…³ç³»** - ç¦»å©šã€å†å©šã€é¢†å…»ç­‰éƒ½èƒ½æ­£ç¡®å¤„ç†

## æœªæ¥æ‰©å±•

1. **å¤šè§†è§’åˆ‡æ¢** - ç”¨æˆ·å¯ä»¥åˆ‡æ¢æŸ¥çœ‹ä¸åŒå®¶åº­æˆå‘˜çš„è§†è§’
2. **å®¶æ—æ ‘å¯è§†åŒ–** - ç”Ÿæˆå›¾å½¢åŒ–çš„å®¶æ—æ ‘
3. **æ™ºèƒ½æ¨è** - æ ¹æ®äº’åŠ¨é¢‘ç‡æ¨èæ¶ˆæ¯è®¾ç½®
4. **ç¾¤ç»„æ¶ˆæ¯** - å‘æ•´ä¸ªå®¶åº­å‘é€ç¾¤ç»„æ¶ˆæ¯
5. **é‡è¦äº‹ä»¶æé†’** - è‡ªåŠ¨æé†’å®¶åº­æˆå‘˜çš„ç”Ÿæ—¥ã€çºªå¿µæ—¥ç­‰
